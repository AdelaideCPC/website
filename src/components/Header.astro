---
import { JOIN_LINK } from "@/data/links";

interface Props {
  noBorder?: boolean;
}

const { noBorder = false } = Astro.props;

type Links = {
  text: string;
  href: string;
  children?: Links[];
};

const LINKS: Links[] = [
  {
    text: "About",
    href: "/about",
    children: [
      { text: "AUCPL", href: "/about/aucpl" },
      { text: "AllUni", href: "/about/alluni" },
      { text: "Committee", href: "/about/committee" },
    ],
  },
  { text: "Events", href: "/events" },
  { text: "Resources", href: "/resources" },
  { text: "Sponsors", href: "/sponsors" },
  { text: "Join", href: JOIN_LINK },
];
---

<header id="header" class="text-xl relative" data-no-border={noBorder}>
  <div
    id="header-container"
    class=`hidden xl:block ${noBorder ? "" : "border-b"} z-50 transition-colors duration-300`
  >
    <div class="mx-auto max-w-7xl flex grow py-4">
      <a href="/">
        <img
          src="/acpc-logo-short.svg"
          alt="ACPC Logo"
          class="h-12 mr-4 inline-block"
        />
      </a>
      <nav class="flex grow pl-6 place-content-end items-center">
        <ul class="flex gap-6" id="desktop-nav">
          {
            LINKS.map((link, index) => (
              <li class="nav-item">
                <div class="nav-link-container">
                  <a class="nav-link" href={link.href}>
                    <span class="nav-link-text">{link.text}</span>
                  </a>
                  {link.children && link.children.length > 0 && (
                    <button
                      class="dropdown-toggle"
                      aria-expanded="false"
                      aria-label={`Toggle ${link.text} submenu`}
                      data-dropdown-index={index}
                    >
                      <svg
                        class="dropdown-indicator inline-block w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>
                  )}
                </div>
              </li>
            ))
          }
        </ul>
      </nav>
    </div>
  </div>

  {/* Dropdown panel - full width below navbar */}
  <div class="dropdown-panel" id="dropdown-panel">
    <div class="mx-auto max-w-7xl pb-10">
      <div class="dropdown-content" id="dropdown-content">
        {/* Content will be dynamically populated */}
      </div>
    </div>
  </div>

  {/* Mobile */}
  <div id="mobile-header" class="z-50 w-full px-8">
    {/* Mobile header */}
    <div class="flex xl:hidden py-4 w-full">
      <div class="flex flex-1 place-content-between">
        <a href="/">
          <img
            src="/acpc-logo-short.svg"
            alt="ACPC Logo"
            class="h-10 mr-4 inline-block"
          />
        </a>
        <button
          id="hamburger-menu"
          class="grid place-content-center h-fit self-center"
          aria-label="Toggle navigation"
          aria-expanded="false"
        >
          <div class="header-bar bg-white w-[30px] h-0.5 my-1"></div>
          <div class="header-bar bg-white w-[30px] h-0.5 my-1"></div>
          <div class="header-bar bg-white w-[30px] h-0.5 my-1"></div>
        </button>
      </div>
    </div>
    {/* Mobile menu */}
    <div
      id="nav-menu"
      style="display:none;"
      class="flex flex-col h-screen overflow-y-scroll"
    >
      <nav class="pt-8">
        <ul class="flex flex-col gap-6 mb-auto">
          {
            LINKS.map((link, index) => (
              <li class="mobile-nav-item">
                <div class="flex items-center justify-between">
                  <a href={link.href}>{link.text}</a>
                  {link.children && link.children.length > 0 && (
                    <button
                      class="mobile-dropdown-toggle p-2"
                      data-mobile-index={index}
                      aria-expanded="false"
                      aria-label={`Toggle ${link.text} submenu`}
                    >
                      <svg
                        class="mobile-dropdown-icon w-4 h-4 transition-transform"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>
                  )}
                </div>
                {link.children && link.children.length > 0 && (
                  <ul class="mobile-dropdown-content" style="display:none;">
                    {link.children.map((child) => (
                      <li class="pl-4 pt-3">
                        <a href={child.href}>{child.text}</a>
                      </li>
                    ))}
                  </ul>
                )}
              </li>
            ))
          }
        </ul>
      </nav>
    </div>
  </div>
</header>

<style is:global>
  /* Navigation link underline animation */
  .nav-link-container {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .nav-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    transition: color 0.3s ease;
  }

  .dropdown-toggle {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0.25rem;
    display: inline-flex;
    align-items: center;
    transition: color 0.3s ease;
  }

  .dropdown-toggle:hover,
  .dropdown-toggle:focus {
    opacity: 0.8;
  }

  .dropdown-toggle:focus {
    outline: 2px solid currentColor;
    outline-offset: 2px;
    border-radius: 2px;
  }

  .nav-link-text {
    position: relative;
  }

  .nav-link-text::after,
  .dropdown-link::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background-color: currentColor;
    transform: scaleX(0);
    transform-origin: center;
    transition: transform 0.2s ease;
  }

  .nav-link-text::after {
    bottom: -4px;
  }

  .dropdown-link::after {
    bottom: 4px;
  }

  .nav-link:hover .nav-link-text::after,
  .dropdown-link:hover::after {
    transform: scaleX(1) !important;
  }

  /* Animation from left */
  .from-left .nav-link-text::after,
  .from-left::after {
    transform-origin: left;
  }

  /* Animation from right */
  .from-right .nav-link-text::after,
  .from-right::after {
    transform-origin: right;
  }

  /* Animation from center (default) */
  .from-center .nav-link-text::after,
  .from-center::after {
    transform-origin: center;
  }

  /* Dropdown panel styles */
  .nav-item {
    position: relative;
  }

  /* Header background when dropdown is active with noBorder */
  #header-container.dropdown-bg-active {
    background-color: var(--color-base);
  }

  .dropdown-panel {
    position: absolute;
    inset: 100% 0 auto;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
    z-index: 50;
    background-color: var(--color-base);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .dropdown-panel.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .dropdown-content {
    padding: 1.5rem 0;
    display: flex;
    gap: 2rem;
  }

  .dropdown-link {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 0;
    color: white;
    text-decoration: none;
    transition: color 0.3s ease;
    font-size: 1.2rem;
    position: relative;
  }

  /* Mobile dropdown styles */
  .mobile-dropdown-toggle {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
  }

  .mobile-dropdown-content {
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .mobile-dropdown-icon {
    transition: transform 0.3s ease;
  }

  .mobile-dropdown-toggle[aria-expanded="true"] .mobile-dropdown-icon {
    transform: rotate(180deg);
  }

  /* Mobile hamburger menu styles */
  .open .header-bar:nth-of-type(1) {
    transform: rotate(-45deg) translate(-2px, -3px);
    transform-origin: bottom right;
  }

  .open .header-bar:nth-of-type(2) {
    opacity: 0;
    transform: scale(0);
  }

  .open .header-bar:nth-of-type(3) {
    transform: rotate(45deg) translate(-2px, 3px);
    transform-origin: top right;
  }
</style>

<script is:inline define:vars={{ NAV_DATA: LINKS }}>
  const DIRECTION_CLASSES = {
    LEFT: "from-left",
    RIGHT: "from-right",
    CENTER: "from-center",
  };
  const HIDE_DELAY_MS = 100;
  const NO_HOVER_INDEX = -1;

  // Track if user has moved mouse to prevent dropdown activation on page load
  let hasMouseMoved = false;
  document.addEventListener(
    "mousemove",
    () => {
      hasMouseMoved = true;
    },
    { once: true },
  );

  // Shared directional underline animation logic
  function setupDirectionalAnimation(container, linkSelector, resetElement) {
    if (!container) return;

    const links = Array.from(container.querySelectorAll(linkSelector));
    let lastHoveredIndex = NO_HOVER_INDEX;

    links.forEach((link, index) => {
      link.addEventListener("mouseenter", () => {
        link.classList.remove(...Object.values(DIRECTION_CLASSES));

        const direction =
          lastHoveredIndex === NO_HOVER_INDEX || index === lastHoveredIndex
            ? DIRECTION_CLASSES.CENTER
            : index > lastHoveredIndex
              ? DIRECTION_CLASSES.LEFT
              : DIRECTION_CLASSES.RIGHT;

        link.classList.add(direction);
        lastHoveredIndex = index;
      });
    });

    resetElement?.addEventListener("mouseleave", () => {
      lastHoveredIndex = NO_HOVER_INDEX;
    });
  }

  // Desktop navigation directional underline animation
  (() => {
    const desktopNav = document.getElementById("desktop-nav");
    setupDirectionalAnimation(
      desktopNav,
      ".nav-link",
      desktopNav?.parentElement,
    );
  })();

  // Dropdown panel functionality
  (() => {
    const dropdownPanel = document.getElementById("dropdown-panel");
    const dropdownContent = document.getElementById("dropdown-content");
    const navLinks = document.querySelectorAll(".nav-link");
    const dropdownToggles = document.querySelectorAll(".dropdown-toggle");
    const header = document.getElementById("header");
    const headerContainer = document.getElementById("header-container");

    if (!dropdownPanel || !dropdownContent) return;

    const hasNoBorder = header?.getAttribute("data-no-border") === "true";
    let currentActiveIndex = NO_HOVER_INDEX;

    const toggleDropdownBackground = (isActive) => {
      if (hasNoBorder && headerContainer) {
        headerContainer.classList.toggle("dropdown-bg-active", isActive);
      }
    };

    const hideDropdown = () => {
      dropdownPanel.classList.remove("active");
      toggleDropdownBackground(false);
      currentActiveIndex = NO_HOVER_INDEX;

      // Reset all toggle buttons
      dropdownToggles.forEach((toggle) => {
        toggle.setAttribute("aria-expanded", "false");
      });

      // Remove dropdown links from tab order
      const dropdownLinks = dropdownContent.querySelectorAll(".dropdown-link");
      dropdownLinks.forEach((link) => {
        link.setAttribute("tabindex", "-1");
      });
    };

    const showDropdown = (index) => {
      const navItem = NAV_DATA[index];
      if (!navItem?.children) return;

      dropdownContent.innerHTML = navItem.children
        .map(
          (child) =>
            `<a class="dropdown-link" href="${child.href}" tabindex="-1">${child.text}</a>`,
        )
        .join("");

      dropdownPanel.classList.add("active");
      toggleDropdownBackground(true);
      currentActiveIndex = index;

      // Update aria-expanded for the active toggle
      dropdownToggles.forEach((toggle, idx) => {
        toggle.setAttribute("aria-expanded", idx === index ? "true" : "false");
      });

      // Setup directional animation for new dropdown links after DOM update
      setTimeout(() => {
        setupDirectionalAnimation(
          dropdownPanel,
          ".dropdown-link",
          dropdownPanel,
        );

        // Add dropdown links to tab order and setup keyboard navigation
        const dropdownLinks =
          dropdownContent.querySelectorAll(".dropdown-link");
        dropdownLinks.forEach((link, idx) => {
          link.setAttribute("tabindex", "0");

          // Handle Tab from last child item to go back to main nav
          if (idx === dropdownLinks.length - 1) {
            link.addEventListener("keydown", (e) => {
              if (e.key === "Tab" && !e.shiftKey) {
                e.preventDefault();
                hideDropdown();
                // Find the next nav item after the current dropdown
                const allNavItems = Array.from(
                  document.querySelectorAll(
                    "#desktop-nav .nav-link, #desktop-nav .dropdown-toggle",
                  ),
                );
                const currentToggle = document.querySelector(
                  `.dropdown-toggle[data-dropdown-index="${currentActiveIndex}"]`,
                );
                const currentIndex = allNavItems.indexOf(currentToggle);
                const nextItem = allNavItems[currentIndex + 1];
                if (nextItem) {
                  nextItem.focus();
                }
              }
            });
          }

          // Handle Shift+Tab from first child item to go back to toggle
          if (idx === 0) {
            link.addEventListener("keydown", (e) => {
              if (e.key === "Tab" && e.shiftKey) {
                e.preventDefault();
                const currentToggle = document.querySelector(
                  `.dropdown-toggle[data-dropdown-index="${currentActiveIndex}"]`,
                );
                currentToggle?.focus();
              }
            });
          }
        });
      }, 0);
    };

    // Handle dropdown toggle button interactions
    dropdownToggles.forEach((toggle) => {
      const toggleDropdown = () => {
        const index = parseInt(toggle.getAttribute("data-dropdown-index"));
        if (currentActiveIndex === index) {
          hideDropdown();
        } else {
          showDropdown(index);
        }
      };

      toggle.addEventListener("click", (e) => {
        e.preventDefault();
        toggleDropdown();
      });

      toggle.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggleDropdown();
        } else if (e.key === "Tab" && !e.shiftKey) {
          const index = parseInt(toggle.getAttribute("data-dropdown-index"));
          if (
            currentActiveIndex === index &&
            dropdownPanel.classList.contains("active")
          ) {
            const firstDropdownLink =
              dropdownContent.querySelector(".dropdown-link");
            if (firstDropdownLink) {
              e.preventDefault();
              firstDropdownLink.focus();
            }
          }
        }
      });

      // Handle hover on toggle button
      toggle.addEventListener("mouseenter", () => {
        if (hasMouseMoved) {
          const index = parseInt(toggle.getAttribute("data-dropdown-index"));
          showDropdown(index);
        }
      });
    });

    // Handle hover on nav links (hide dropdown when hovering non-dropdown links)
    navLinks.forEach((link) => {
      link.addEventListener("mouseenter", () => {
        if (
          !link.nextElementSibling?.classList.contains("dropdown-toggle") &&
          dropdownPanel.classList.contains("active")
        ) {
          hideDropdown();
        }
      });
    });

    // Hide dropdown when mouse leaves both the nav and dropdown panel
    let isOverNav = false;
    let isOverDropdown = false;

    const checkAndHide = () => {
      if (!isOverNav && !isOverDropdown) {
        hideDropdown();
      }
    };

    header?.addEventListener("mouseenter", () => {
      isOverNav = true;
    });

    header?.addEventListener("mouseleave", () => {
      isOverNav = false;
      setTimeout(checkAndHide, HIDE_DELAY_MS);
    });

    dropdownPanel.addEventListener("mouseenter", () => {
      isOverDropdown = true;
    });

    dropdownPanel.addEventListener("mouseleave", () => {
      isOverDropdown = false;
      setTimeout(checkAndHide, HIDE_DELAY_MS);
    });

    // Handle Escape key to close dropdown
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && dropdownPanel.classList.contains("active")) {
        const toggleIndex = currentActiveIndex;
        hideDropdown();
        document
          .querySelector(
            `.dropdown-toggle[data-dropdown-index="${toggleIndex}"]`,
          )
          ?.focus();
      }
    });
  })();

  // Mobile dropdown functionality
  (() => {
    const mobileToggles = document.querySelectorAll(".mobile-dropdown-toggle");

    mobileToggles.forEach((toggle) => {
      toggle.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isExpanded = toggle.getAttribute("aria-expanded") === "true";
        const dropdown = toggle
          .closest(".mobile-nav-item")
          ?.querySelector(".mobile-dropdown-content");

        if (!dropdown) return;

        toggle.setAttribute("aria-expanded", String(!isExpanded));
        dropdown.style.display = isExpanded ? "none" : "block";
      });
    });
  })();

  // Mobile menu toggle
  (() => {
    const mobileHeader = document.getElementById("mobile-header");
    const menuButton = document.getElementById("hamburger-menu");
    const menu = document.getElementById("nav-menu");
    const header = document.getElementById("header");
    const root = document.getElementById("root");

    let menuOpen = false;

    const toggleMenu = () => {
      menuOpen = !menuOpen;

      mobileHeader.classList.toggle("bg-base", menuOpen);
      header.classList.toggle("open", menuOpen);
      menu.style.display = menuOpen ? "block" : "none";
      root.style.overflowY = menuOpen ? "hidden" : "visible";
      menuButton.setAttribute("aria-expanded", String(menuOpen));
    };

    menuButton.addEventListener("click", toggleMenu);
  })();
</script>
